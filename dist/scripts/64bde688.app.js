"use strict";angular.module("sosPomocApp",["ngResource"]).config(["$routeProvider",function(a){a.when("/needs/new",{controller:"AdFormCtrl",templateUrl:"views/new.html"}).when("/needs/:id/edit",{controller:"AdFormCtrl",templateUrl:"views/edit.html"}).when("/needs/:id",{}).when("/needs",{}).otherwise({redirectTo:"/needs"})}]).factory("Ad",["$resource",function(a){return a("/ads/:id",{id:"@id"},{show:{method:"GET",isArray:!0},get:{method:"GET"},create:{method:"POST"},remove:{method:"DELETE"},edit:{method:"PUT"}})}]).config(["$httpProvider",function(a){return a.defaults.useXDomain=!0,delete a.defaults.headers.common["X-Requested-With"]}]),angular.module("sosPomocApp").factory("adsService",["Ad","$q","$timeout",function(a,b,c){function d(){a.show(g,function(a){e=a,f.resolve(e),f=b.defer()}),h=c(d,6e4)}var e=[],f=b.defer(),g={},h=c(d,1);return{setFilter:function(a){g=a,c(h),d()},promiseAds:function(){return f.promise},ads:function(){return e},categories:[{name:"Úklid",value:"cleaning"},{name:"Vysoušeče",value:"dryers"},{name:"Oblečení",value:"clothing"},{name:"Finanční pomoc",value:"financial_aid"},{name:"Čisticí prostředky",value:"detergents"},{name:"Potraviny",value:"grocery"},{name:"Hygiena",value:"hygiene"},{name:"Přístřeší",value:"shelter"},{name:"Zázemí/hlídání dětí",value:"facilities"},{name:"Nářadí",value:"gear"}]}}]),angular.module("sosPomocApp").controller("MainCtrl",function(){}),angular.module("sosPomocApp").controller("MapCtrl",["$scope","adsService",function(a,b){function c(a){var c=b.categories.filter(function(b){return a.categories&&a.categories.indexOf(b.value)>=0}).map(function(a){return a.name});return{content:'<div class="description"><p>'+a.description+"</p>"+"<p><strong>Kategorie:</strong> "+c.join(", ")+"</p>"+"</div>"+'<div class="contact">'+"<p><strong>Autor:</strong></p>"+'<p><a href="mailto:'+a.email+'">'+a.name+"</a></p>"+"<p>"+a.contact+"</p>"+"</div>",pane:"floatPane",closeBoxMargin:"-17px",pixelOffset:new google.maps.Size(-150,0),boxStyle:{width:"300px",minHeight:"200px"}}}function d(b){var d=new google.maps.Marker({position:new google.maps.LatLng(b.location.lat,b.location.lng),map:a.map,icon:"/images/marker.png"}),e=new InfoBox(c(b));google.maps.event.addListener(d,"click",function(){e.open(a.map,d)}),a.markers[b._id]=d,a.infoBoxes[b._id]=e}function e(b){a.markers[b._id].setPosition(new google.maps.LatLng(b.location.lat,b.location.lng)),a.infoBoxes[b._id].setContent(c(b).content)}function f(b){google.maps.event.clearListeners(a.markers[b._id],"click"),a.markers[b._id].setMap(null),delete a.markers[b._id],delete a.infoBoxes[b._id]}function g(c){c.filter(function(b){return a.markers[b._id]}).forEach(e),c.filter(function(b){return!a.markers[b._id]}).forEach(d);var h,i=c.map(function(a){return a._id});for(h in a.markers)a.markers.hasOwnProperty(h)&&i.indexOf(h)<0&&f({_id:h});b.promiseAds().then(g)}b.promiseAds().then(g),a.map=null,a.markers={},a.infoBoxes={},a.initMap=function(){a.map=new google.maps.Map(document.getElementById("map"),{center:new google.maps.LatLng(50.0632464,14.4097413),zoom:14,mapTypeId:google.maps.MapTypeId.ROADMAP,mapTypeControl:!1,streetViewControl:!1,panControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},zoomControlOptions:{position:google.maps.ControlPosition.RIGHT_BOTTOM},styles:[{stylers:[{color:"#faf1c2"}]},{elementType:"labels.text.stroke",stylers:[{color:"#fffae6"}]},{elementType:"labels.text.fill",stylers:[{color:"#332d10"}]},{featureType:"administrative",elementType:"geometry.stroke",stylers:[{color:"#f3e6a8"},{lightness:-37},{saturation:-47},{gamma:1.82}]},{featureType:"landscape",elementType:"geometry",stylers:[{color:"#fff9df"}]},{featureType:"road",elementType:"geometry.fill",stylers:[{color:"#f4d387"},{saturation:7},{lightness:39}]},{featureType:"road",elementType:"geometry.stroke",stylers:[{color:"#e0d387"},{lightness:-9}]},{featureType:"transit",elementType:"geometry.fill",stylers:[{color:"#ccbe9a"}]},{featureType:"water",elementType:"geometry",stylers:[{color:"#cce6e0"}]},{featureType:"poi.park",elementType:"geometry",stylers:[{color:"#daecc2"}]},{featureType:"poi.attraction",elementType:"geometry",stylers:[{color:"#d9c99a"}]},{featureType:"poi.business",elementType:"geometry.fill",stylers:[{color:"#f0e9cf"}]},{featureType:"poi.government",stylers:[{color:"#f0e7c1"}]},{featureType:"poi.place_of_worship",stylers:[{color:"#ede4b4"}]},{featureType:"landscape.natural.terrain",stylers:[{color:"#d9e9ba"}]}]})}}]),angular.module("sosPomocApp").controller("FilterCtrl",["$scope","adsService",function(a,b){function c(){return a.categories.filter(function(a){return a.checked}).map(function(a){return a.value})}a.categories=b.categories.map(function(a){return a.checked=!0,a}),a.toggle=function(a,d){a.checked=!a.checked,d.preventDefault(),b.setFilter({categories:c()})}}]),angular.module("sosPomocApp").controller("AdFormCtrl",["$scope","Ad","adsService","$http","$routeParams","$location",function(a,b,c,d,e,f){a.findMe=function(){return a.geolocationAvailable?navigator.geolocation.getCurrentPosition(function(b){return a.$apply(function(){return a.newItem.location={lat:b.coords.latitude,lon:b.coords.longitude}})},function(){}):void 0},a.initAutocomplete=function(){var b,c;return c=document.getElementById("newLocation"),c?(b=new google.maps.places.Autocomplete(c),google.maps.event.addDomListener(c,"keydown",function(a){return 13===a.keyCode?a.preventDefault():void 0}),google.maps.event.addListener(b,"place_changed",function(){var c;return c=b.getPlace(),c.geometry?c.geometry.location?a.$apply(function(){return a.newItem.location={lat:c.geometry.location.jb,lon:c.geometry.location.kb,name:document.getElementById("newLocation").value}}):void 0:void 0})):void 0};var g=function(c){b.get({id:c},function(b){b.errors?f.path("/"):(angular.forEach(b.categories,function(a,c){b.categories[c].checked=!0}),a.newItem=b,a.newItem.categories=$.extend(a.allCategories,a.newItem.categories),a.newItem.location.name=a.newItem.location.place,delete a.newItem.location.place)})};a.remove=function(){b.remove({id:e.id},function(b){b.ok?f.path("/"):a.errors.push("Smazání se nezdařilo")})},a.init=function(){a.errors=[],a.formSent=!1,a.newItem={},a.asked=!1,a.isTouchDevice=$("html").hasClass("touch"),a.geolocationAvailable=!1,a.editMode=!1,a.allCategories=c.categories.map(function(a){return a.checked=!1,a}),e.id?(g(e.id),a.editMode=!0):(a.newItem.categories=angular.copy(a.allCategories),!a.newItem.location&&a.isTouchDevice&&(a.geolocationAvailable=navigator.geolocation?!0:!1,a.asked=!0,a.findMe())),a.initAutocomplete()};var h=function(){var c=angular.copy(a.newItem.categories);a.newItem.categories=a.newItem.categories.filter(function(a){return 1==a.checked}),b.create(a.newItem,function(b){b.errors?(a.errors.push("Odeslání se nezdařilo"),a.newItem.categories=c):(a.errors=[],a.formSent=!0,a.newItem={},a.newItem.categories=a.allCategories)})};a.submit=function(){if(a.errors=[],a.formSent=!1,!a.createForm.$invalid)if(a.newItem.location)if(a.newItem.location.name)a.newItem.location.place=a.newItem.location.name,h();else{var b=a.newItem.location,c="http://maps.googleapis.com/maps/api/geocode/json?latlng="+b.lat+","+b.lon+"&sensor=true";d.get(c).success(function(b){b.results.length>0&&(a.newItem.location.place=b.results[0].formatted_address),h()})}else a.errors.push("Lokalita je povinná položka.")},a.toggleCategory=function(b){a.newItem.categories[b].checked=!a.newItem.categories[b].checked}}]);